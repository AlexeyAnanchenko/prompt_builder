import os
from dotenv import load_dotenv
from pathlib import Path
from typing import Dict, Optional, Any

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ —Ñ–∞–π–ª–∞ .env –≤ os.environ
# –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –Ω–µ —Ö—Ä–∞–Ω–∏—Ç—å —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–ø–∞—Ä–æ–ª–∏) –≤ –∫–æ–¥–µ.
load_dotenv()

# ==========================================
# üìÇ –ü–£–¢–ò –ö –§–ê–ô–õ–ê–ú
# ==========================================
# –ò—Å–ø–æ–ª—å–∑—É–µ–º pathlib –¥–ª—è –∫—Ä–æ—Å—Å–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω–æ—Å—Ç–∏ –ø—É—Ç–µ–π (Windows/Linux/Mac)
VERSIONS_FILE: Path = Path("prompt_versions.json")

# ==========================================
# üñ•Ô∏è –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –°–¢–†–ê–ù–ò–¶–´ STREAMLIT
# ==========================================
# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã, –ø–µ—Ä–µ–¥–∞–≤–∞–µ–º—ã–µ –≤ st.set_page_config()
PAGE_CONFIG: Dict[str, Any] = {
    "page_title": "Prompt Builder",  # –ó–∞–≥–æ–ª–æ–≤–æ–∫ –≤–∫–ª–∞–¥–∫–∏ –±—Ä–∞—É–∑–µ—Ä–∞
    "page_icon": "üñä",               # –ò–∫–æ–Ω–∫–∞ –≤–∫–ª–∞–¥–∫–∏ (favicon)
    "layout": "wide",                # –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å—é —à–∏—Ä–∏–Ω—É —ç–∫—Ä–∞–Ω–∞
    "initial_sidebar_state": "collapsed" # –°–∞–π–¥–±–∞—Ä —Å–∫—Ä—ã—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
}

# ==========================================
# üî¢ –õ–ò–ú–ò–¢–´ –ò –ö–û–ù–°–¢–ê–ù–¢–´
# ==========================================
# –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –æ–∫–Ω–∞ LLM (–Ω–∞–ø—Ä–∏–º–µ—Ä, GPT-4 –∏–ª–∏ Claude)
MAX_TOKENS: int = 128000 

# –ú–Ω–æ–∂–∏—Ç–µ–ª—å –¥–ª—è –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø–æ–¥—Å—á–µ—Ç–∞ —Ç–æ–∫–µ–Ω–æ–≤, –µ—Å–ª–∏ —Ç–æ–∫–µ–Ω–∏–∑–∞—Ç–æ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.
# –û–±—ã—á–Ω–æ 1 —Å–ª–æ–≤–æ ‚âà 0.75 —Ç–æ–∫–µ–Ω–∞, –∑–Ω–∞—á–∏—Ç 1 —Å–ª–æ–≤–æ * 1.3 ‚âà –∫–æ–ª-–≤–æ —Ç–æ–∫–µ–Ω–æ–≤.
TOKEN_MULTIPLIER: float = 1.3  

# ==========================================
# üé® UI –ö–û–ù–°–¢–ê–ù–¢–´ (–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å)
# ==========================================
# –í—ã—Å–æ—Ç–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –æ–±–ª–∞—Å—Ç–µ–π –≤ –ø–∏–∫—Å–µ–ª—è—Ö –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å–µ–∫—Ü–∏–π
TEXTAREA_HEIGHTS: Dict[str, int] = {
    "system_prompt": 150, # –í—ã—Å–æ—Ç–∞ –ø–æ–ª—è —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞
    "user_query": 400,    # –í—ã—Å–æ—Ç–∞ –ø–æ–ª—è –≤–≤–æ–¥–∞ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    "llm_response": 200,  # –í—ã—Å–æ—Ç–∞ –ø–æ–ª—è –æ—Ç–≤–µ—Ç–∞ (–≤ —á–∞—Ç–µ)
}

# ==========================================
# üí¨ –°–û–û–ë–©–ï–ù–ò–Ø –ò –¢–ï–ö–°–¢–´
# ==========================================
# –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤ –æ—à–∏–±–æ–∫ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
MESSAGES: Dict[str, str] = {
    "error_no_mapping": "‚ö†Ô∏è –ù–µ—Ç —Å–ª–æ–≤–∞—Ä—è –¥–ª—è —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏. –°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –∑–∞–º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç.",
    "error_no_llm_response": "‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç LLM",
    "success_version_saved": "‚úÖ –í–µ—Ä—Å–∏—è '{}' —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!",
    "success_version_loaded": "‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–∞ –≤–µ—Ä—Å–∏—è '{}'",
    "success_version_deleted": "‚úÖ –í–µ—Ä—Å–∏—è '{}' —É–¥–∞–ª–µ–Ω–∞",
    "success_prompt_generated": "‚úÖ –ü—Ä–æ–º–ø—Ç —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω!",
    "success_masked_elements": "‚úÖ –ü—Ä–æ–º–ø—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω! –ó–∞–º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–æ {} —ç–ª–µ–º–µ–Ω—Ç–æ–≤",
    "success_unmasked": "‚úÖ –û—Ç–≤–µ—Ç —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω!",
    "info_no_confidential": "‚ÑπÔ∏è –ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã",
    "info_no_versions": "üî≠ –ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –≤–µ—Ä—Å–∏–π",
    "warning_no_namespaces": "‚ö†Ô∏è –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö namespace",
    "warning_enter_version_name": "‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤–µ—Ä—Å–∏–∏",
    "toast_copied": "‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!",
}

# ==========================================
# üóÑÔ∏è –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ë–ê–ó–´ –î–ê–ù–ù–´–•
# ==========================================
class DatabaseConfig:
    """
    –ö–ª–∞—Å—Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
    –ë–µ—Ä–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.
    """
    
    # –•–æ—Å—Ç –ë–î (–∞–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞)
    HOST: str = os.getenv("DB_HOST", "localhost")
    # –ü–æ—Ä—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –¥–ª—è PostgreSQL - 5432)
    PORT: int = int(os.getenv("DB_PORT", "5432"))
    # –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ë–î
    USER: str = os.getenv("DB_USER", "postgres")
    # –ü–∞—Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–º–æ–∂–µ—Ç –±—ã—Ç—å None, –µ—Å–ª–∏ –Ω–µ –∑–∞–¥–∞–Ω, –Ω–æ –≤–∞–ª–∏–¥–∞—Ü–∏—è —ç—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç)
    PASSWORD: Optional[str] = os.getenv("DB_PASSWORD")
    # –ò–º—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    NAME: str = os.getenv("DB_NAME", "query_db")
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—É–ª–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã —Å –ë–î)
    POOL_MIN_SIZE: int = int(os.getenv("DB_POOL_MIN_SIZE", "2")) # –ú–∏–Ω–∏–º—É–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
    POOL_MAX_SIZE: int = int(os.getenv("DB_POOL_MAX_SIZE", "10")) # –ú–∞–∫—Å–∏–º—É–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
    
    @classmethod
    def get_connection_string(cls) -> str:
        """
        –§–æ—Ä–º–∏—Ä—É–µ—Ç —Å—Ç—Ä–æ–∫—É –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è SQLAlchemy –∏–ª–∏ –¥—Ä—É–≥–∏—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤.
        –§–æ—Ä–º–∞—Ç: postgresql://user:password@host:port/dbname
        """
        return f"postgresql://{cls.USER}:{cls.PASSWORD}@{cls.HOST}:{cls.PORT}/{cls.NAME}"
    
    @classmethod
    def validate(cls) -> None:
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –æ–∫—Ä—É–∂–µ–Ω–∏—è.
        –í—ã–∑—ã–≤–∞–µ—Ç –æ—à–∏–±–∫—É ValueError, –µ—Å–ª–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.
        """
        if not cls.PASSWORD:
            raise ValueError("‚ùå –û—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: DB_PASSWORD –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è (.env)")
        if not cls.NAME:
            raise ValueError("‚ùå –û—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: DB_NAME –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è (.env)")